{% extends "base-template.html" %}

{% block title %}
    Mailbox for {{ current_user.name }}
{% endblock %}

{% block content %}
    <h1 id="main-heading">Mailbox</h1>

    <table>
        <tr>
            <th>Sender</th>
            <th>Sent</th>
            <th>Title</th>
            <th>Message Body</th>
        </tr>
        {% for message in messages %}
            <tr>
                <td>{{ message.sender.name }}</td>
                {% if message.sent_time is not none %}
                    <td>{{ message.sent_time.year }}-{{ message.sent_time.month }}-{{ message.sent_time.day }}</td>
                {% else %}
                    <td>-</td>
                {% endif %}
                <td id="encrypted">{{ message.title }}</td>
                <td >{{ "Body encrypted" }}</td>
            </tr>
        {% endfor %}
    </table>


        <p>Upload private key</p>
        <input type="file" name="private_key" id="priv-file" enctype="multipart/form-data" />
        <button onclick="readPrivateKey()">Read Private Key</button><span id="priv-loaded"></span>

        <br /> <br />
        <button onclick="decryptRSA()">Decrypt the Message</button>

        <p id="decrypted"></p>


    <script src="/static/js/rsa.js"></script>

    <script>


        let privateKey;

        function readPrivateKey() {
            let files = document.getElementById("priv-file").files;
            let file = files[0];
            let reader = new FileReader();

            reader.onloadend = function (event) {
                privateKey = event.target.result;
                privateKey = privateKey.replace(/(\r\n|\n|\r)/gm, "");
                document.getElementById("priv-loaded").innerHTML = "Private key loaded";
            };
            reader.readAsText(file);

        }

       //async function decryptRSA() {
       //    const keyObject = crypto.KeyObject.from(privateKey);
       //    let ciphertxt = crypto.privateDecrypt(keyObject, {{ messages.title }})
       //    console.log(ciphertxt)
       //}

        function rsaDecrypt() {
            // Get the encrypted message
            let cipher = document.getElementById("encrypted").innerHTML;
            console.log(cipher)
            // cipher = btoa(cipher);
            // Create a RSA object
            let rsaDecrypt = new JSEncrypt();
            // Set the private key we want to use for decryption
            rsaDecrypt.setPrivateKey(privateKey);
            console.log()
            // Decrypt the message
            let plainText = rsaDecrypt.decrypt(cipher);
            console.log(plainText);
            // Show the decryted message
            document.getElementById("decrypted").innerHTML = plainText;
        }

        function decrypt() {
            let clearText = CryptoJS.AES.decrypt(encrypted, key);
            document.getElementById("clear").value = clearText.toString(CryptoJS.enc.Utf8);
        }

    

    </script>
{% endblock %}

